@model App.Web.Models.DashboardViewModel
@{
    ViewData["Title"] = "الصفحة الرئيسية";
}

@functions {
    string GetPriorityColor(string priority)
    {
        return priority switch
        {
            "High" => "#dc3545",
            "Medium" => "#ffc107",
            "Low" => "#28a745",
            _ => "#6c757d"
        };
    }

    string GetPriorityClass(string priority)
    {
        return priority switch
        {
            "High" => "danger",
            "Medium" => "warning",
            "Low" => "success",
            _ => "secondary"
        };
    }

    string GetRoleNameArabic(string role)
    {
        return role switch
        {
            "Super Admin" => "مدير النظام",
            "Admin" => "مدير",
            "OfficeManager" => "مدير المكتب",
            "Leader" => "قائد",
            "User" => "مستخدم",
            _ => role
        };
    }

    string GetPriorityBackgroundColor(string priority)
    {
        return priority switch
        {
            "High" or "عالي" => "#fef2f2",      // Light red background
            "Medium" or "متوسط" => "#fffbeb",   // Light yellow background
            "Low" or "منخفض" => "#f0fdf4",      // Light green background
            _ => "#f8f9fa"                      // Light gray background
        };
    }
}

<div class="d-flex flex-column-fluid">
    <div class="container">
        @if (@HttpContextAccessor.HttpContext.Session.GetString("passwordExpire") != null)
        {
            <div class="row">
                <div class="col-lg-12">
                    <div lang="ar" dir="rtl" class="alert alert-custom alert-notice alert-light-danger fade show" role="alert">
                        <div class="alert-icon"><i class="flaticon-warning"></i></div>
                        <div class="alert-text">@HttpContextAccessor.HttpContext.Session.GetString("passwordExpire")</div>
                        <div class="alert-close">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true"><i class="ki ki-close"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
<div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container">

        <!--begin::Dashboard-->
        <!--begin::Row-->
        <div class="row">
            <!--begin::Welcome Card-->
            <div class="col-xl-12">
                <div class="card card-custom gutter-b" style="background: linear-gradient(135deg, #29504D 0%, #3a6b66 100%);height: 120px;">
                    <div class="card-body d-flex align-items-center py-4">
                        <div class="symbol symbol-40 symbol-circle mr-4">
                            <div class="symbol-label" style="background: rgba(255,255,255,0.2);">
                                <i class="fas fa-tachometer-alt text-white" style="font-size: 18px;"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column flex-grow-1">
                            <h3 class="text-white font-weight-bolder mb-1" style="font-size: 1.2rem;">مرحباً بك في لوحة التحكم</h3>
                            <p class="text-white opacity-75 font-size-sm mb-0">
                                @if (Model.UserRole == Roles.SuperAdmin)
                                {
                                    <span>مدير النظام - يمكنك رؤية جميع الإحصائيات والاجتماعات</span>
                                }
                                else if (Model.UserRole == Roles.Admin || Model.UserRole == Roles.OfficeManager || Model.UserRole == Roles.Leader)
                                {
                                    <span>@GetRoleNameArabic(Model.UserRole) - قسم: @Model.UserDepartment</span>
                                }
                                else
                                {
                                    <span>مستخدم - اجتماعاتك الشخصية</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Welcome Card-->
        </div>
        <!--end::Row-->
        <!--begin::Statistics Cards-->
        <div class="row">
            <div class="col-xl-3">
                <!--begin::Total Meetings Card-->
                <div class="card card-custom bg-primary gutter-b" style="height: 150px">
                    <div class="card-body d-flex align-items-center">
                        <div class="symbol symbol-50 symbol-circle mr-5">
                            <div class="symbol-label" style="background: rgba(255,255,255,0.2);">
                                <i class="fas fa-calendar-alt text-white" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="text-inverse-primary font-weight-bolder font-size-h2">@Model.TotalMeetings</div>
                            <div class="text-inverse-primary font-weight-bold font-size-lg">إجمالي الاجتماعات</div>
                        </div>
                    </div>
                </div>
                <!--end::Total Meetings Card-->
            </div>
            <div class="col-xl-3">
                <!--begin::Today Meetings Card-->
                <div class="card card-custom bg-success gutter-b" style="height: 150px">
                    <div class="card-body d-flex align-items-center">
                        <div class="symbol symbol-50 symbol-circle mr-5">
                            <div class="symbol-label" style="background: rgba(255,255,255,0.2);">
                                <i class="fas fa-calendar-day text-white" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="text-inverse-primary font-weight-bolder font-size-h2">@Model.TodayMeetings</div>
                            <div class="text-inverse-primary font-weight-bold font-size-lg">اجتماعات اليوم</div>
                        </div>
                    </div>
                </div>
                <!--end::Today Meetings Card-->
            </div>
            <div class="col-xl-3">
                <!--begin::Completed Meetings Card-->
                <div class="card card-custom bg-info gutter-b" style="height: 150px">
                    <div class="card-body d-flex align-items-center">
                        <div class="symbol symbol-50 symbol-circle mr-5">
                            <div class="symbol-label" style="background: rgba(255,255,255,0.2);">
                                <i class="fas fa-check-circle text-white" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="text-inverse-primary font-weight-bolder font-size-h2">@Model.CompletedMeetings</div>
                            <div class="text-inverse-primary font-weight-bold font-size-lg">اجتماعات مكتملة</div>
                        </div>
                    </div>
                </div>
                <!--end::Completed Meetings Card-->
            </div>
            <div class="col-xl-3">
                <!--begin::Pending Meetings Card-->
                <div class="card card-custom bg-warning gutter-b" style="height: 150px">
                    <div class="card-body d-flex align-items-center">
                        <div class="symbol symbol-50 symbol-circle mr-5">
                            <div class="symbol-label" style="background: rgba(255,255,255,0.2);">
                                <i class="fas fa-clock text-white" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="text-inverse-primary font-weight-bolder font-size-h2">@Model.PendingMeetings</div>
                            <div class="text-inverse-primary font-weight-bold font-size-lg">اجتماعات مجدولة</div>
                        </div>
                    </div>
                </div>
                <!--end::Pending Meetings Card-->
            </div>
        </div>
        <!--end::Statistics Cards-->
        @if (Model.UserRole == "Super Admin")
        {
            <!--begin::Admin Statistics-->
            <div class="row">
                <div class="col-xl-6">
                    <!--begin::Users Card-->
                    <div class="card card-custom gutter-b" style="height: 150px">
                        <div class="card-body d-flex align-items-center">
                            <div class="symbol symbol-50 symbol-circle mr-5">
                                <div class="symbol-label" style="background: #e3f2fd;">
                                    <i class="fas fa-users text-primary" style="font-size: 20px;"></i>
                                </div>
                            </div>
                            <div class="d-flex flex-column">
                                <div class="text-dark font-weight-bolder font-size-h2">@Model.TotalUsers</div>
                                <div class="text-muted font-weight-bold font-size-lg">إجمالي المستخدمين</div>
                            </div>
                        </div>
                    </div>
                    <!--end::Users Card-->
                </div>
                <div class="col-xl-6">
                    <!--begin::Departments Card-->
                    <div class="card card-custom gutter-b" style="height: 150px">
                        <div class="card-body d-flex align-items-center">
                            <div class="symbol symbol-50 symbol-circle mr-5">
                                <div class="symbol-label" style="background: #f3e5f5;">
                                    <i class="fas fa-building text-purple" style="font-size: 20px;"></i>
                                </div>
                            </div>
                            <div class="d-flex flex-column">
                                <div class="text-dark font-weight-bolder font-size-h2">@Model.TotalDepartments</div>
                                <div class="text-muted font-weight-bold font-size-lg">إجمالي الأقسام</div>
                            </div>
                        </div>
                    </div>
                    <!--end::Departments Card-->
                </div>
            </div>
            <!--end::Admin Statistics-->
        }
        <!--end::Row-->
        <!--begin::Charts Row-->
        <div class="row">
            <div class="col-xl-6">
                <!--begin::Priority Distribution Chart-->
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label font-weight-bolder text-dark">توزيع أولويات الاجتماعات</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">حسب الأولوية</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <div id="priorityChart" class="chart-container">
                                <div class="chart-loading" id="priorityLoading">جاري تحميل البيانات...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Priority Distribution Chart-->
            </div>
            <div class="col-xl-6">
                <!--begin::Monthly Meetings Chart-->
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label font-weight-bolder text-dark">إحصائيات الاجتماعات الشهرية</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">آخر 6 أشهر</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <div id="monthlyMeetingsChart" class="chart-container">
                                <div class="chart-loading" id="monthlyLoading">جاري تحميل البيانات...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Monthly Meetings Chart-->
            </div>
        </div>
        <!--end::Charts Row-->
        <!--begin::Status Chart Row-->
        <div class="row">
            <div class="col-xl-6">
                <!--begin::Status Distribution Chart-->
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label font-weight-bolder text-dark">توزيع حالات الاجتماعات</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">حسب الحالة</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <div id="statusChart" class="chart-container">
                                <div class="chart-loading" id="statusLoading">جاري تحميل البيانات...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Status Distribution Chart-->
            </div>
            <div class="col-xl-6">
                <!--begin::Upcoming Meetings-->
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label font-weight-bolder text-dark">الاجتماعات القادمة</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">أقرب 5 اجتماعات</span>
                        </h3>
                        <div class="card-toolbar">
                            <a href="@Url.Action("Index", "Calendar")" class="btn btn-primary font-weight-bolder font-size-sm">
                                <i class="fas fa-calendar-alt mr-2"></i>عرض التقويم
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (Model.UpcomingMeetings.Any())
                        {
                            <div class="timeline timeline-3">
                                @foreach (var meeting in Model.UpcomingMeetings)
                                {
                                    <div class="timeline-item" style="background: @GetPriorityBackgroundColor(meeting.Priority); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid @GetPriorityColor(meeting.Priority);">
                                        <div class="timeline-media">
                                            <div class="symbol symbol-40 symbol-circle">
                                                <div class="symbol-label" style="background: @GetPriorityColor(meeting.Priority);">
                                                    <i class="fas fa-calendar text-white"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="timeline-content">
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <div class="mr-2">
                                                    <a href="@Url.Action("Details", "Calendar", new { id = meeting.Id })" class="text-dark font-weight-bolder font-size-lg text-hover-primary">@meeting.Title</a>
                                                    <span class="text-dark-50 d-block font-size-sm font-weight-bold">@meeting.OrganizerName</span>
                                                </div>
                                                <span class="label label-light-@GetPriorityClass(meeting.Priority) label-inline font-weight-bolder text-uppercase">@meeting.Priority</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="text-dark-75 font-size-sm mr-2 font-weight-bold">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    @meeting.StartTime.ToString("yyyy/MM/dd HH:mm")
                                                </span>
                                                @if (!string.IsNullOrEmpty(meeting.Location))
                                                {
                                                    <span class="text-dark-75 font-size-sm font-weight-bold">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                                        @meeting.Location
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-dark-75 font-size-sm font-weight-bold">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                                        موقع غير محدد
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-calendar-times text-muted" style="font-size: 48px;"></i>
                                <p class="text-muted font-size-lg mt-3">لا توجد اجتماعات قادمة</p>
                            </div>
                        }
                    </div>
                </div>
                <!--end::Upcoming Meetings-->
            </div>
        </div>
        <!--end::Status Chart Row-->
        <!--end::Dashboard-->
    </div>
    <!--end::Container-->
</div>

@section Scripts {
    <style>
        .apexcharts-canvas {
            direction: ltr !important;
        }
        
        .apexcharts-legend {
            direction: rtl !important;
        }
        
        .apexcharts-tooltip {
            direction: rtl !important;
        }
        
        .card-body {
            position: relative;
        }
        
        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }
        
        .card-body {
            min-height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .card {
            height: 400px;
        }
        
        .chart-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }
        
        /* Fix header bell icon color to match notification bell */
        .flaticon2-bell-2 {
            color: #ff9800 !important;
        }
        
        /* Target all bell icons in the header/notification area */
        .topbar-item .flaticon2-bell-2,
        .notification-dropdown .flaticon2-bell-2,
        .symbol .flaticon2-bell-2 {
            color: #ff9800 !important;
        }
    </style>
    <script>
        // Wait for jQuery to be available
        function initDashboard() {
            if (typeof $ !== 'undefined' && typeof ApexCharts !== 'undefined') {
                $(document).ready(function() {
            // Monthly Meetings Chart - Simplified
            var monthlyData = @Html.Raw(Json.Serialize(Model.MeetingStatsByMonth.Select(x => x.Count)));
            var monthlyLabels = @Html.Raw(Json.Serialize(Model.MeetingStatsByMonth.Select(x => x.Month)));
            
            var monthlyOptions = {
                series: [{
                    name: 'الاجتماعات',
                    data: monthlyData
                }],
                chart: {
                    type: 'bar',
                    height: 280,
                    fontFamily: 'Cairo, sans-serif',
                    background: 'transparent',
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#29504D'],
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val + ' اجتماع'
                    },
                    style: {
                        fontSize: '12px',
                        fontFamily: 'Cairo, sans-serif',
                        fontWeight: 'bold',
                        colors: ['#fff']
                    }
                },
                xaxis: {
                    categories: monthlyLabels,
                    labels: {
                        style: {
                            fontFamily: 'Cairo, sans-serif',
                            fontSize: '12px',
                            colors: '#333',
                            fontWeight: 600
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontFamily: 'Cairo, sans-serif',
                            fontSize: '12px',
                            colors: '#333',
                            fontWeight: 600
                        },
                        formatter: function (val) {
                            return Math.round(val)
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                grid: {
                    show: false
                },
                tooltip: {
                    style: {
                        fontFamily: 'Cairo, sans-serif',
                        fontSize: '14px'
                    },
                    theme: 'light',
                    y: {
                        formatter: function (val) {
                            return val + ' اجتماع'
                        }
                    }
                },
                legend: {
                    show: false
                }
            };

            var monthlyChart = new ApexCharts(document.querySelector("#monthlyMeetingsChart"), monthlyOptions);
            monthlyChart.render().then(() => {
                document.getElementById('monthlyLoading').style.display = 'none';
            }).catch((error) => {
                console.error('Error rendering monthly chart:', error);
                document.getElementById('monthlyLoading').textContent = 'خطأ في تحميل البيانات';
            });

            // Priority Distribution Chart
            var priorityOptions = {
                series: @Html.Raw(Json.Serialize(Model.MeetingStatsByPriority.Select(x => x.Count))),
                chart: {
                    type: 'donut',
                    height: 280,
                    fontFamily: 'Cairo, sans-serif',
                    background: 'transparent'
                },
                colors: ['#dc3545', '#ffc107', '#28a745'],
                labels: @Html.Raw(Json.Serialize(Model.MeetingStatsByPriority.Select(x => x.Priority))),
                legend: {
                    position: 'bottom',
                    fontFamily: 'Cairo, sans-serif',
                    fontSize: '14px',
                    fontWeight: 600,
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 6
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 5
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    fontSize: '16px',
                                    fontFamily: 'Cairo, sans-serif',
                                    fontWeight: 600,
                                    color: '#333'
                                },
                                value: {
                                    show: true,
                                    fontSize: '20px',
                                    fontFamily: 'Cairo, sans-serif',
                                    fontWeight: 'bold',
                                    color: '#29504D'
                                },
                                total: {
                                    show: true,
                                    showAlways: false,
                                    label: 'إجمالي',
                                    fontSize: '14px',
                                    fontFamily: 'Cairo, sans-serif',
                                    fontWeight: 600,
                                    color: '#666',
                                    formatter: function (w) {
                                        return w.globals.seriesTotals.reduce((a, b) => {
                                            return a + b
                                        }, 0)
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val, opts) {
                        return val.toFixed(1) + '%'
                    },
                    style: {
                        fontFamily: 'Cairo, sans-serif',
                        fontSize: '12px',
                        fontWeight: 'bold',
                        colors: ['#fff']
                    },
                    dropShadow: {
                        enabled: true,
                        top: 1,
                        left: 1,
                        blur: 1,
                        color: '#000',
                        opacity: 0.45
                    }
                },
                tooltip: {
                    style: {
                        fontFamily: 'Cairo, sans-serif',
                        fontSize: '14px'
                    },
                    theme: 'light',
                    y: {
                        formatter: function (val, opts) {
                            return val + ' اجتماع'
                        }
                    }
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['#fff']
                }
            };

            var priorityChart = new ApexCharts(document.querySelector("#priorityChart"), priorityOptions);
            priorityChart.render().then(() => {
                document.getElementById('priorityLoading').style.display = 'none';
            }).catch((error) => {
                console.error('Error rendering priority chart:', error);
                document.getElementById('priorityLoading').textContent = 'خطأ في تحميل البيانات';
            });

            // Status Distribution Chart - Vertical bar chart
            var statusData = @Html.Raw(Json.Serialize(Model.MeetingStatsByStatus.Select(x => x.Count)));
            var statusLabels = @Html.Raw(Json.Serialize(Model.MeetingStatsByStatus.Select(x => x.Status)));
            
            var statusOptions = {
                series: [{
                    name: 'الاجتماعات',
                    data: statusData
                }],
                chart: {
                    type: 'bar',
                    height: 280,
                    fontFamily: 'Cairo, sans-serif',
                    background: 'transparent',
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#17a2b8', '#28a745', '#dc3545'],
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val + ' اجتماع'
                    },
                    style: {
                        fontSize: '12px',
                        fontFamily: 'Cairo, sans-serif',
                        fontWeight: 'bold',
                        colors: ['#fff']
                    }
                },
                xaxis: {
                    categories: statusLabels,
                    labels: {
                        style: {
                            fontFamily: 'Cairo, sans-serif',
                            fontSize: '12px',
                            colors: '#333',
                            fontWeight: 600
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontFamily: 'Cairo, sans-serif',
                            fontSize: '12px',
                            colors: '#333',
                            fontWeight: 600
                        },
                        formatter: function (val) {
                            return Math.round(val)
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                grid: {
                    show: false
                },
                tooltip: {
                    style: {
                        fontFamily: 'Cairo, sans-serif',
                        fontSize: '14px'
                    },
                    theme: 'light',
                    y: {
                        formatter: function (val) {
                            return val + ' اجتماع'
                        }
                    }
                },
                legend: {
                    show: false
                }
            };

            var statusChart = new ApexCharts(document.querySelector("#statusChart"), statusOptions);
            statusChart.render().then(() => {
                document.getElementById('statusLoading').style.display = 'none';
            }).catch((error) => {
                console.error('Error rendering status chart:', error);
                document.getElementById('statusLoading').textContent = 'خطأ في تحميل البيانات';
            });
                });
            } else {
                // Retry after a short delay if jQuery or ApexCharts is not ready
                setTimeout(initDashboard, 100);
            }
        }

        // Initialize the dashboard
        initDashboard();
    </script>
}
